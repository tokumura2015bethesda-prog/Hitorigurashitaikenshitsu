<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; color: #333; margin: 0; background: #f8f9fa; }
    header { background: #007BBB; color: white; padding: 1rem; text-align: center; }
    .container { max-width: 900px; margin: auto; padding: 20px; }
    
    .tabs { display: flex; justify(content): center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 10px 20px; cursor: pointer; border: 1px solid #007BBB; background: white; border-radius: 5px; font-weight: bold; transition: 0.3s; flex: 1; min-width: 70px; text-align: center;}
    .tab-btn.active { background: #007BBB; color: white; }
    
    .map-outer-frame {
      width: 100%;
      height: 75vh;
      background: #eee;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      touch-action: auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .map-wrapper {
      position: absolute;
      display: none;
      width: 100%;
      height: 100%;
      align-items: center;
      justify-content: center;
    }
    .map-wrapper.active { display: flex; }
    .map-img-container { position: relative; display: inline-block; line-height: 0; }
    .map-img { 
      max-width: 100%; max-height: 75vh; 
      width: auto; height: auto; display: block; 
      border-radius: 5px; pointer-events: none; object-fit: contain; 
    }
    
    .marker {
      position: absolute; 
      width: 30px; height: 30px; 
      background: rgba(220, 50, 50, 0.6); color: white; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 18px; transition: all 0.2s; 
      border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transform: translate(-50%, -50%); z-index: 5;
    }
    .marker-badge {
      position: absolute; top: -8px; right: -8px; 
      background: #FFD700; color: #333;
      width: 18px; height: 18px; border-radius: 50%; 
      font-size: 11px; font-weight: bold;
      line-height: 18px; text-align: center; border: 1px solid white;
    }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; }
    .modal-content {
      position: relative; width: 95%; max-width: 1100px; margin: auto;
      background: white; border-radius: 12px; display: flex; flex-direction: column; 
      max-height: 96vh; overflow: hidden;
    }
    .img-container {
      width: 100%; height: 75vh; background: #000; position: relative;
      display: flex; align-items: center; justify-content: center; overflow: hidden;
    }
    .modal-img { max-width: 100%; max-height: 100%; object-fit: contain; will-change: transform; }
    .modal-text { width: 100%; padding: 25px 40px; background: #fff; box-sizing: border-box; overflow-y: auto; }
    #v-room { margin: 0 0 10px 0; font-size: 1.6rem; color: #333; }
    #v-desc { font-size: 1.1rem; line-height: 1.7; color: #555; white-space: pre-wrap; }

    .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: white; border: none; font-size: 40px; padding: 10px 15px; cursor: pointer; z-index: 10; border-radius: 4px; }
    .prev { left: 10px; } .next { right: 10px; }
    .slide-counter { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.6); padding: 4px 15px; border-radius: 20px; font-size: 14px; }
    .close-btn { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 30px; font-weight: bold; color: #333; z-index: 101; background: rgba(255,255,255,0.85); width: 44px; height: 44px; line-height: 40px; text-align: center; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

    .thumb-section { margin-top: 40px; border-top: 2px solid #ddd; padding-top: 20px; }
    .tel-link { color: inherit; text-decoration: none; cursor: default; }

    @media (max-width: 768px) {
      .marker { width: 16px !important; height: 16px !important; font-size: 10px !important; border-width: 1px !important; }
      .marker-badge { width: 11px !important; height: 11px !important; font-size: 8px !important; line-height: 11px !important; top: -6px !important; right: -6px !important; border: none !important; }
      .img-container { height: 60vh; }
      .modal-text { padding: 20px; }
      #v-room { font-size: 1.3rem; }
      .tel-link { color: #007BBB; text-decoration: underline; cursor: pointer; font-weight: bold; }
    }
  </style>
</head>
<body>

<header><h1>京都市一人暮らし体験室 オンライン内覧</h1></header>

<div class="container">
  <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 5px solid #007BBB; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
    <p style="margin: 0 0 10px 0; line-height: 1.6; color: #333;">
      本サイトでは、一人暮らし体験事業でお使いいただく物件の各部屋の様子を写真でご紹介しています。間取り図上の矢印をクリックするか、下部の写真一覧から気になる箇所をご覧ください。
    </p>
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd;">
      <a href="https://www.city.kyoto.lg.jp/hokenfukushi/page/0000332919.html" target="_blank" style="display: inline-flex; align-items: center; color: #007BBB; text-decoration: none; font-weight: bold;">
        <span style="margin-right: 5px;">▶</span> 事業の詳細についてはこちら（外部リンク）
      </a>
    </div>
  </div>

  <div class="tabs">
    <div class="tab-btn active" onclick="switchFloor('外観')">外観</div>
    <div class="tab-btn" onclick="switchFloor('1F')">1階</div>
    <div class="tab-btn" onclick="switchFloor('2F')">2階</div>
    <div class="tab-btn" onclick="switchFloor('3F')">3階</div>
  </div>

 <div style="text-align: center; margin-bottom: 30px;">
  <div class="map-outer-frame" id="map-parent-frame">
    <div id="map-外観" class="map-wrapper active"><div class="map-img-container"><img src="IMG_7016.jpeg" class="map-img"><div id="markers-外観"></div></div></div>
    <div id="map-1F" class="map-wrapper"><div class="map-img-container"><img src="" class="map-img"><div id="markers-1F"></div></div></div>
    <div id="map-2F" class="map-wrapper"><div class="map-img-container"><img src="2f.jpg" class="map-img"><div id="markers-2F"></div></div></div>
    <div id="map-3F" class="map-wrapper"><div class="map-img-container"><img src="3f.jpg" class="map-img"><div id="markers-3F"></div></div></div>
  </div>
  <p style="font-size: 0.8rem; color: #888; margin-top: 8px;">※間取り図は指で拡大・移動できます</p>
 </div>

  <div class="thumb-section">
    <h3>写真一覧（フロア別）</h3>
    <div id="floor-lists-container"></div>
  </div>

  <footer style="margin-top: 50px; padding: 40px 20px; background: #f1f3f5; text-align: center; border-radius: 10px; color: #555; font-size: 0.9rem; line-height: 1.8;">
    <p style="font-weight: bold; margin-bottom: 12px; color: #333; font-size: 1rem;">お問い合わせ先</p>
    <p style="margin-bottom: 8px;">
      社会福祉法人 世光福祉会<br>
      障がい児・者相談支援センター「いまじん」
    </p>
    <p style="margin-bottom: 5px;">
      電話：<span class="tel-link" onclick="if(window.innerWidth <= 600) location.href='tel:0755853217'">075-585-3217</span>
    </p>
    <p style="font-size: 0.85rem; color: #666;">
      受付時間：9:00～18:00<br>
      <span style="font-size: 0.8rem;">（土日祝日・年末年始を除く）</span>
    </p>
    <p style="margin-top: 25px; font-size: 0.75rem; color: #aaa;">© 2026 障がい児・者相談支援センター「いまじん」</p>
  </footer>
</div>

<div id="viewer" class="modal" onclick="closeViewer()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="closeViewer()">×</span>
    <div class="modal-body">
      <div class="img-container">
        <button class="nav-btn prev" onclick="changeSlide(-1)">❮</button>
        <img id="v-img" class="modal-img">
        <button class="nav-btn next" onclick="changeSlide(1)">❯</button>
        <div id="v-counter" class="slide-counter"></div>
      </div>
      <div class="modal-text">
        <span id="v-floor" style="background:#eee; padding:2px 8px; border-radius:4px; font-size:12px;"></span>
        <h2 id="v-room"></h2>
        <p id="v-desc"></p>
      </div>
    </div>
  </div>
</div>

<script>
  // ★ここに最新のGASデプロイURLを貼り付けてください
  const GAS_API_URL = "ここにデプロイURLを貼る";

  let allData = [];
  let groupedData = {};
  let currentGroup = [];
  let currentIndex = 0;

  let mScale = 1; let mOffsetX = 0; let mOffsetY = 0;
  let mIsDragging = false; let mStartX, mStartY; let mInitialDist = 0;

  // GitHub Pages用に fetch メソッドを使用してデータを取得
  window.onload = function() {
    fetch(GAS_API_URL)
      .then(response => response.json())
      .then(data => {
        // GAS側で .slice(1) 済みなら data そのまま、そうでなければ data.slice(1)
        let cleanData = data.filter(row => row[1] && row[3]);
        cleanData.sort((a, b) => {
          const floorA = a[1]; const floorB = b[1];
          if (floorA === '外観') return -1;
          if (floorB === '外観') return 1;
          return floorA.localeCompare(floorB, undefined, { numeric: true });
        });
        allData = cleanData; 
        processData(allData);
        renderMarkers();
        renderFloorThumbs(allData);
        initMapControls();
      })
      .catch(error => {
        console.error("データの読み込みに失敗しました:", error);
        alert("データの読み込みに失敗しました。GASのURLを確認してください。");
      });
  };

  function initMapControls() {
    const frame = document.getElementById('map-parent-frame');
    frame.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        mInitialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
      } else if (e.touches.length === 1) {
        mIsDragging = true;
        mStartX = e.touches[0].pageX - mOffsetX;
        mStartY = e.touches[0].pageY - mOffsetY;
      }
    }, {passive: true});

    frame.addEventListener('touchmove', (e) => {
      if (mScale > 1 || e.touches.length === 2) {
        if (e.cancelable) e.preventDefault();
      } else {
        mIsDragging = false;
        return;
      }

      if (e.touches.length === 2) {
        const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        mScale = Math.min(Math.max(1, mScale * (dist / mInitialDist)), 4);
        mInitialDist = dist;
      } else if (e.touches.length === 1 && mIsDragging) {
        mOffsetX = e.touches[0].pageX - mStartX;
        mOffsetY = e.touches[0].pageY - mStartY;
      }
      applyMapTransform();
    }, {passive: false});

    frame.addEventListener('touchend', () => { mIsDragging = false; });
  }

  function applyMapTransform() {
    const target = document.querySelector('.map-wrapper.active .map-img-container');
    const frame = document.getElementById('map-parent-frame');
    if (!target) return;
    if (mScale <= 1.01) {
      mScale = 1; mOffsetX = 0; mOffsetY = 0;
    } else {
      const limitX = (frame.clientWidth * (mScale - 1)) / 2;
      const limitY = (frame.clientHeight * (mScale - 1)) / 2;
      mOffsetX = Math.min(Math.max(mOffsetX, -limitX), limitX);
      mOffsetY = Math.min(Math.max(mOffsetY, -limitY), limitY);
    }
    target.style.transform = `translate(${mOffsetX}px, ${mOffsetY}px) scale(${mScale})`;
  }

  function resetMap() { mScale = 1; mOffsetX = 0; mOffsetY = 0; applyMapTransform(); }

  function processData(data) {
    groupedData = {};
    data.forEach(row => {
      const groupKey = row[1] + "-" + row[4]; 
      if (!groupedData[groupKey]) groupedData[groupKey] = [];
      groupedData[groupKey].push(row);
    });
  }

  function renderMarkers() {
    document.querySelectorAll('.marker').forEach(m => m.remove());
    const renderedSpots = {};
    let lastX = null, lastY = null, lastAngle = 0, lastFloor = "";
    allData.forEach(row => {
      const floor = row[1];
      if (floor === '外観') return; 
      let x = row[6], y = row[7], angle = row[8] || 0;
      if (!x && floor === lastFloor) { x = lastX; y = lastY; angle = lastAngle; } 
      else { lastX = x; lastY = y; lastAngle = angle; lastFloor = floor; }
      if (!x || !y) return;
      const spotKey = `${floor}-${x}-${y}`;
      if (renderedSpots[spotKey]) return;
      renderedSpots[spotKey] = true;
      const wrapper = document.getElementById(`markers-${floor}`);
      if (!wrapper) return;
      const marker = document.createElement('div');
      marker.className = 'marker';
      marker.style.left = x + '%'; marker.style.top = y + '%';
      marker.innerHTML = `<span style="transform: rotate(${angle}deg); display: inline-block;">➔</span>`;
      const groupKey = row[1] + "-" + row[4];
      const groupPhotos = groupedData[groupKey];
      if (groupPhotos && groupPhotos.length > 1) {
        const badge = document.createElement('div');
        badge.className = 'marker-badge'; badge.innerText = groupPhotos.length;
        marker.appendChild(badge);
      }
      marker.onclick = (e) => { e.stopPropagation(); openViewer(groupKey, 0, false); };
      wrapper.appendChild(marker);
    });
  }

  function renderFloorThumbs(data) {
    const container = document.getElementById('floor-lists-container');
    if(!container) return; container.innerHTML = '';
    const floors = {};
    data.forEach(row => { if (!floors[row[1]]) floors[row[1]] = []; floors[row[1]].push(row); });
    for (const floor in floors) {
      const floorSection = document.createElement('div');
      floorSection.style.marginBottom = "30px";
      floorSection.innerHTML = `<h4 style="border-left:5px solid #2c3e50; padding-left:10px; margin-bottom:10px; font-weight:bold;">${floor}</h4>`;
      const grid = document.createElement('div');
      grid.style = "display:grid; grid-template-columns:repeat(auto-fill, minmax(110px,1fr)); gap:10px;";
      floors[floor].forEach(row => {
        const item = document.createElement('div');
        item.innerHTML = `<img src="${row[3]}" style="width:100%; height:80px; object-fit:cover; border-radius:6px; cursor:pointer;">`;
        item.onclick = () => openViewer(null, allData.indexOf(row), true);
        grid.appendChild(item);
      });
      floorSection.appendChild(grid);
      container.appendChild(floorSection);
    }
  }

  function openViewer(groupKey, index, isAllMode) {
    if (isAllMode) { currentGroup = allData; currentIndex = index; } 
    else { currentGroup = groupedData[groupKey]; currentIndex = index; }
    updateViewer();
    document.getElementById('viewer').style.display = 'flex';
  }

  function updateViewer() {
    const item = currentGroup[currentIndex]; if(!item) return;
    document.getElementById('v-img').src = item[3];
    document.getElementById('v-floor').innerText = item[1];
    document.getElementById('v-room').innerText = item[2];
    document.getElementById('v-desc').innerText = item[5] ? item[5].trim() : "";
    document.getElementById('v-counter').innerText = `${currentIndex + 1} / ${currentGroup.length}`;
    document.querySelectorAll('.nav-btn').forEach(b => b.style.display = currentGroup.length > 1 ? 'block' : 'none');
    resetZoom();
  }

  function changeSlide(n) {
    if (currentGroup.length <= 1) return;
    currentIndex = (currentIndex + n + currentGroup.length) % currentGroup.length;
    updateViewer();
  }

  function switchFloor(floor) {
    document.querySelectorAll('.map-wrapper, .tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('map-' + floor).classList.add('active');
    event.currentTarget.classList.add('active');
    resetMap();
  }

  function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

  let scale = 1; let touchStartX = 0; let currentTranslateX = 0; let isPinching = false;
  let initialPinchDistance = 0; let dragX = 0; let dragY = 0; let lastStartX = 0; let lastStartY = 0;
  const viewerElement = document.getElementById('viewer');
  const imgElement = document.getElementById('v-img');

  viewerElement.addEventListener('touchstart', e => {
    imgElement.style.transition = 'none';
    if (e.touches.length === 2) { isPinching = true; initialPinchDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); } 
    else { isPinching = false; touchStartX = e.changedTouches[0].screenX; lastStartX = e.changedTouches[0].screenX - dragX; lastStartY = e.changedTouches[0].screenY - dragY; }
  }, {passive: false});

  viewerElement.addEventListener('touchmove', e => {
    if (isPinching && e.touches.length === 2) { e.preventDefault(); const currentDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); scale = Math.min(Math.max(1, scale * (currentDistance / initialPinchDistance)), 4); updateTransform(); initialPinchDistance = currentDistance; } 
    else if (!isPinching) { if (scale === 1) { if (currentGroup.length > 1) { currentTranslateX = e.changedTouches[0].screenX - touchStartX; imgElement.style.transform = `translateX(${currentTranslateX}px) scale(1)`; } } else { e.preventDefault(); dragX = e.changedTouches[0].screenX - lastStartX; dragY = e.changedTouches[0].screenY - lastStartY; updateTransform(); } }
  }, {passive: false});

  viewerElement.addEventListener('touchend', e => {
    imgElement.style.transition = 'transform 0.3s ease-out';
    if (isPinching) { if (e.touches.length === 0) isPinching = false; return; }
    if (scale === 1) { if (currentGroup.length > 1) { const threshold = window.innerWidth * 0.25; if (currentTranslateX < -threshold) { changeSlide(1); } else if (currentTranslateX > threshold) { changeSlide(-1); } else { updateTransform(); } } else { updateTransform(); } currentTranslateX = 0; }
  }, {passive: true});

  function updateTransform() {
    if (scale > 1) { imgElement.style.transform = `translate(${dragX}px, ${dragY}px) scale(${scale})`; } else { imgElement.style.transform = `translate(0px, 0px) scale(1)`; }
  }

  function resetZoom() { scale = 1; dragX = 0; dragY = 0; currentTranslateX = 0; updateTransform(); }
</script>
</body>
</html>
