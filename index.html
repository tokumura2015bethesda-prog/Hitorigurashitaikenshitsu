<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; color: #333; margin: 0; background: #f8f9fa; }
    body.modal-open { overflow: hidden; position: fixed; width: 100%; height: 100%; }
    header { background: #007BBB; color: white; padding: 1rem; text-align: center; }
    .container { max-width: 900px; margin: auto; padding: 20px; }
    
    /* ▼▼▼ 追加：全体ローディング画面のスタイル ▼▼▼ */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease, visibility 0.5s;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007BBB;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { color: #666; font-size: 0.9rem; }
    /* ▲▲▲ ここまで ▲▲▲ */

    .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 10px 20px; cursor: pointer; border: 1px solid #007BBB; background: white; border-radius: 5px; font-weight: bold; transition: 0.3s; flex: 1; min-width: 70px; text-align: center;}
    .tab-btn.active { background: #007BBB; color: white; }
    .map-outer-frame { width: 100%; height: 75vh; background: #eee; border-radius: 10px; overflow: hidden; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
    .map-wrapper { position: absolute; display: none; width: 100%; height: 100%; align-items: center; justify-content: center; }
    .map-wrapper.active { display: flex; }
    .map-img-container { position: relative; display: inline-block; line-height: 0; }
    .map-img { max-width: 100%; max-height: 75vh; width: auto; height: auto; display: block; border-radius: 5px; pointer-events: none; object-fit: contain; }
    .marker { position: absolute; width: 30px; height: 30px; background: rgba(220, 50, 50, 0.6); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: all 0.2s; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transform: translate(-50%, -50%); z-index: 5; }
    .marker-badge { position: absolute; top: -8px; right: -8px; background: #FFD700; color: #333; width: 18px; height: 18px; border-radius: 50%; font-size: 11px; font-weight: bold; line-height: 18px; text-align: center; border: 1px solid white; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; align-items: center; justify-content: center; touch-action: none; }
    .modal-content { position: relative; width: 95%; max-width: 1100px; margin: auto; background: white; border-radius: 12px; display: flex; flex-direction: column; max-height: 90vh; overflow: hidden; }

    .close-btn { 
      position: fixed; 
      top: 20px; 
      right: 20px; 
      top: max(20px, env(safe-area-inset-top)); 
      cursor: pointer; 
      font-size: 28px; 
      font-weight: bold; 
      color: #333; 
      z-index: 2000; 
      background: rgba(255,255,255,0.9); 
      width: 44px; 
      height: 44px; 
      line-height: 44px; 
      text-align: center; 
      border-radius: 50%; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.5); 
      backdrop-filter: blur(4px); 
    }

    .img-container { width: 100%; height: 60vh; background: #000; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .slider-track { display: flex; width: 100%; height: 100%; position: absolute; top: 0; left: 0; will-change: transform; }
    .slide-item { flex: 0 0 100%; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    .modal-img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .modal-text { width: 100%; padding: 25px 40px; background: #fff; box-sizing: border-box; overflow-y: auto; flex: 1; }
    
    #v-room { margin: 0 0 10px 0; font-size: 1.6rem; color: #333; }
    #v-desc { font-size: 1.1rem; line-height: 1.7; color: #555; white-space: pre-wrap; margin: 0; }
    
    .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: white; border: none; font-size: 40px; padding: 10px 15px; cursor: pointer; z-index: 10; border-radius: 4px; }
    .prev { left: 10px; } .next { right: 10px; }
    .slide-counter { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.6); padding: 4px 15px; border-radius: 20px; font-size: 14px; }
    
    .thumb-section { margin-top: 40px; border-top: 2px solid #ddd; padding-top: 20px; }
    .tel-link { color: inherit; text-decoration: none; cursor: default; }

    @media (max-width: 768px) {
      .marker { width: 16px !important; height: 16px !important; font-size: 10px !important; }
      .marker-badge { width: 11px !important; height: 11px !important; font-size: 8px !important; line-height: 11px !important; top: -6px !important; right: -6px !important; }
      .img-container { height: 50vh; }
      .modal-text { padding: 20px; }
      #v-room { font-size: 1.3rem; }
      .tel-link { color: #007BBB; text-decoration: underline; cursor: pointer; font-weight: bold; }
    }
  </style>
</head>
<body>

<div id="loading-screen">
  <div class="spinner"></div>
  <div class="loading-text">ページを準備しています...</div>
</div>

<header><h1>京都市一人暮らし体験室 オンライン内覧</h1></header>

<div class="container">
  <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 5px solid #007BBB; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
    <p style="margin: 0 0 10px 0; line-height: 1.6; color: #333;">本サイトでは、一人暮らし体験事業でお使いいただく物件の各部屋の様子を写真でご紹介しています。間取り図上の矢印をクリックするか、下部の写真一覧から気になる箇所をご覧ください。</p>
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd;">
      <a href="https://www.city.kyoto.lg.jp/hokenfukushi/page/0000332919.html" target="_blank" style="display: inline-flex; align-items: center; color: #007BBB; text-decoration: none; font-weight: bold;"><span style="margin-right: 5px;">▶</span> 事業の詳細についてはこちら（外部リンク）</a>
    </div>
  </div>

  <div class="tabs">
    <div class="tab-btn active" data-floor="外観" onclick="handleTabClick('外観')">外観</div>
    <div class="tab-btn" data-floor="1F" onclick="handleTabClick('1F')">1階</div>
    <div class="tab-btn" data-floor="2F" onclick="handleTabClick('2F')">2階</div>
    <div class="tab-btn" data-floor="3F" onclick="handleTabClick('3F')">3階</div>
  </div>

  <div class="map-outer-frame" id="map-parent-frame">
    <div id="map-外観" class="map-wrapper active"><div class="map-img-container"><img src="IMG_7016.jpeg" class="map-img"><div id="markers-外観"></div></div></div>
    <div id="map-1F" class="map-wrapper"><div class="map-img-container"><img src="IMG_1818.JPG" class="map-img"><div id="markers-1F"></div></div></div>
    <div id="map-2F" class="map-wrapper"><div class="map-img-container"><img src="IMG_1825.jpeg" class="map-img"><div id="markers-2F"></div></div></div>
    <div id="map-3F" class="map-wrapper"><div class="map-img-container"><img src="IMG_1822.jpeg" class="map-img"><div id="markers-3F"></div></div></div>
  </div>
  <p style="text-align:center; font-size: 0.8rem; color: #888; margin-top: 8px;">※間取り図は指で拡大・移動できます</p>

  <div class="thumb-section">
    <h3>写真一覧（フロア別）</h3>
    <div id="floor-lists-container"></div>
  </div>

  <footer style="margin-top: 50px; padding: 40px 20px; background: #f1f3f5; text-align: center; border-radius: 10px; color: #555; font-size: 0.9rem; line-height: 1.8;">
    <p style="font-weight: bold; margin-bottom: 12px; color: #333; font-size: 1rem;">お問い合わせ先</p>
    <p style="margin-bottom: 8px;">社会福祉法人 世光福祉会<br>障がい児・者相談支援センター「いまじん」</p>
    <p style="margin-bottom: 5px;">電話：<span class="tel-link" onclick="if(window.innerWidth <= 600) location.href='tel:0755853217'">075-585-3217</span></p>
    <p style="font-size: 0.85rem; color: #666;">受付時間：9:00～18:00<br><span style="font-size: 0.8rem;">（土日祝日・年末年始を除く）</span></p>
    <p style="font-size: 0.75rem; color: #aaa; margin-top: 25px;">© 2026 障がい児・者相談支援センター「いまじん」</p>
  </footer>
</div>

<div id="viewer" class="modal" onclick="requestCloseViewer()">
  <span class="close-btn" onclick="requestCloseViewer()">×</span>
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="img-container">
      <div id="slider-track" class="slider-track"></div>
      <button class="nav-btn prev" onclick="changeSlide(-1)">❮</button>
      <button class="nav-btn next" onclick="changeSlide(1)">❯</button>
      <div id="v-counter" class="slide-counter"></div>
    </div>
    <div class="modal-text">
      <span id="v-floor" style="background:#eee; padding:2px 8px; border-radius:4px; font-size:12px;"></span>
      <h2 id="v-room"></h2>
      <p id="v-desc"></p>
    </div>
  </div>
</div>

<script>
  const GAS_API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhXGnzIC2gE5UyWBguvXvQ67TDlhntpzzdh9Q4nV9kcwXOPo9XNaMj5WGE1J4U3PicNCAmqKRGZ1RVHQgSAcgX4JDJ23y3eFt7p0B_dVYQvCdG1ryQPBJ0SGUIZ2CNvhPD9WOlt523372OmzLxU2eYZ7nHqu4PS3pA-vutv_1L-i3b3UVJRoKcn0Zc_5v6wXYfQoZzG31Hnm5bN1s_BJ1VXrfh_78JKLSvY5ac4Np-VLiC1voGOj41k7yHVEhJ52ywmg39W43CMRhWcH_kFJKBzlRqnouNkX5b_Lxey&lib=Mp76_62xJm8fQqCNSnmRDrlyIfNZbfkjO";

  let allData = [], groupedData = {}, currentGroup = [], currentIndex = 0;
  let mScale = 1, mOffsetX = 0, mOffsetY = 0, mIsDragging = false, mStartX, mStartY, mInitialDist = 0;

  window.onload = function() {
    history.replaceState({ type: 'tab', floor: '外観' }, '');

    fetch(GAS_API_URL).then(res => res.json()).then(data => {
      let cleanData = data.filter(r => r[1] && r[3]);
      cleanData.sort((a, b) => a[1] === '外観' ? -1 : b[1] === '外観' ? 1 : a[1].localeCompare(b[1], undefined, {numeric:true}));
      allData = cleanData; 
      processData(allData); 
      renderMarkers(); 
      renderFloorThumbs(allData); 
      initMapControls();

      // ▼▼▼ 修正箇所：すべての描画が終わったらローディングを消す ▼▼▼
      const loader = document.getElementById('loading-screen');
      loader.style.opacity = '0';
      setTimeout(() => { loader.style.visibility = 'hidden'; }, 500);
    });
  };

  window.onpopstate = function(event) {
    if (!event.state) return;
    if (document.getElementById('viewer').style.display === 'flex') {
      executeCloseViewer(); 
    }
    if (event.state.type === 'tab') {
      executeSwitchFloor(event.state.floor);
    }
  };

  function handleTabClick(f) {
    history.pushState({ type: 'tab', floor: f }, '');
    executeSwitchFloor(f);
  }

  function executeSwitchFloor(f) {
    document.querySelectorAll('.map-wrapper, .tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('map-' + f).classList.add('active');
    document.querySelector(`.tab-btn[data-floor="${f}"]`).classList.add('active');
    mScale = 1; mOffsetX = 0; mOffsetY = 0; applyMapTransform();
  }

  function openViewer(gk, idx, all) {
    history.pushState({ type: 'viewer' }, '');
    currentGroup = all ? allData : groupedData[gk]; currentIndex = idx;
    buildSlider(); updateViewerInfo();
    document.getElementById('viewer').style.display = 'flex';
    document.body.classList.add('modal-open');
    applyTransform();
  }

  function requestCloseViewer() {
    history.back();
  }

  function executeCloseViewer() {
    document.getElementById('viewer').style.display = 'none';
    document.body.classList.remove('modal-open');
    resetZoomParams();
  }

  function initMapControls() {
    const f = document.getElementById('map-parent-frame');
    f.addEventListener('touchstart', e => {
      if (e.touches.length === 2) mInitialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
      else if (e.touches.length === 1) { mIsDragging = true; mStartX = e.touches[0].pageX - mOffsetX; mStartY = e.touches[0].pageY - mOffsetY; }
    }, {passive:true});
    f.addEventListener('touchmove', e => {
      if (mScale > 1 || e.touches.length === 2) { if (e.cancelable) e.preventDefault(); } else { mIsDragging = false; return; }
      if (e.touches.length === 2) {
        let d = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        mScale = Math.min(Math.max(1, mScale * (d / mInitialDist)), 4); mInitialDist = d;
      } else if (mIsDragging) { mOffsetX = e.touches[0].pageX - mStartX; mOffsetY = e.touches[0].pageY - mStartY; }
      applyMapTransform();
    }, {passive:false});
    f.addEventListener('touchend', () => mIsDragging = false);
  }

  function applyMapTransform() {
    const t = document.querySelector('.map-wrapper.active .map-img-container');
    const f = document.getElementById('map-parent-frame');
    if (!t) return;
    if (mScale <= 1.01) { mScale = 1; mOffsetX = 0; mOffsetY = 0; } else {
      let lx = (f.clientWidth * (mScale - 1)) / 2, ly = (f.clientHeight * (mScale - 1)) / 2;
      mOffsetX = Math.min(Math.max(mOffsetX, -lx), lx); mOffsetY = Math.min(Math.max(mOffsetY, -ly), ly);
    }
    t.style.transform = `translate(${mOffsetX}px, ${mOffsetY}px) scale(${mScale})`;
  }

  function processData(data) {
    groupedData = {};
    data.forEach(r => { let k = r[1] + "-" + r[4]; if (!groupedData[k]) groupedData[k] = []; groupedData[k].push(r); });
  }

  function renderMarkers() {
    document.querySelectorAll('.marker').forEach(m => m.remove());
    let spots = {};
    allData.forEach(r => {
      if (r[1] === '外観' || !r[6]) return;
      let k = `${r[1]}-${r[6]}-${r[7]}`; if (spots[k]) return; spots[k] = true;
      let w = document.getElementById(`markers-${r[1]}`); if (!w) return;
      let m = document.createElement('div'); m.className = 'marker';
      m.style.left = r[6] + '%'; m.style.top = r[7] + '%';
      m.innerHTML = `<span style="transform: rotate(${r[8]||0}deg); display:inline-block;">➔</span>`;
      let gk = r[1] + "-" + r[4], g = groupedData[gk];
      if (g && g.length > 1) { let b = document.createElement('div'); b.className = 'marker-badge'; b.innerText = g.length; m.appendChild(b); }
      m.onclick = e => { e.stopPropagation(); openViewer(gk, 0, false); };
      w.appendChild(m);
    });
  }

  function renderFloorThumbs(data) {
    let c = document.getElementById('floor-lists-container');
    c.innerHTML = ''; 
    let fls = {};
    data.forEach(r => { if (!fls[r[1]]) fls[r[1]] = []; fls[r[1]].push(r); });
    for (let f in fls) {
      let s = document.createElement('div'); s.style.marginBottom = "30px";
      s.innerHTML = `<h4 style="border-left:5px solid #007BBB; padding-left:10px; margin-bottom:10px;">${f}</h4>`;
      let g = document.createElement('div'); g.style = "display:grid; grid-template-columns:repeat(auto-fill, minmax(110px,1fr)); gap:10px;";
      fls[f].forEach(r => {
        let i = document.createElement('div'); i.innerHTML = `<img src="${r[3]}" style="width:100%; height:80px; object-fit:cover; border-radius:6px; cursor:pointer;">`;
        i.onclick = () => openViewer(null, allData.indexOf(r), true); g.appendChild(i);
      });
      s.appendChild(g); c.appendChild(s);
    }
  }

  const track = document.getElementById('slider-track'), viewEl = document.getElementById('viewer');
  let scale = 1, tStartX = 0, cTransX = 0, isPinch = false, inDist = 0, dX = 0, dY = 0, lStartX = 0, lStartY = 0;

  function buildSlider() {
    track.innerHTML = '';
    currentGroup.forEach(item => {
      const div = document.createElement('div');
      div.className = 'slide-item';
      div.innerHTML = `<img src="${item[3]}" class="modal-img">`;
      track.appendChild(div);
    });
  }

  function updateViewerInfo() {
    const item = currentGroup[currentIndex];
    if(!item) return;
    document.getElementById('v-floor').innerText = item[1];
    document.getElementById('v-room').innerText = item[2];
    document.getElementById('v-desc').innerText = item[5] ? item[5].trim() : "";
    document.getElementById('v-counter').innerText = `${currentIndex + 1} / ${currentGroup.length}`;
    document.querySelectorAll('.nav-btn').forEach(b => b.style.display = currentGroup.length > 1 ? 'block' : 'none');
  }

  function changeSlide(n) {
    if (currentGroup.length <= 1) return;
    currentIndex = (currentIndex + n + currentGroup.length) % currentGroup.length;
    track.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    applyTransform(); updateViewerInfo();
    resetZoomParams();
  }

  viewEl.addEventListener('touchstart', e => {
    track.style.transition = 'none';
    if (e.touches.length === 2) { isPinch = true; inDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); } 
    else { isPinch = false; tStartX = e.changedTouches[0].screenX; lStartX = e.changedTouches[0].screenX - dX; lStartY = e.changedTouches[0].screenY - dY; }
  }, {passive: false});

  viewEl.addEventListener('touchmove', e => {
    e.preventDefault();
    if (isPinch && e.touches.length === 2) { 
      let d = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
      scale = Math.min(Math.max(1, scale * (d / inDist)), 4); inDist = d; applyTransform();
    } else if (!isPinch) {
      if (scale === 1) { cTransX = e.changedTouches[0].screenX - tStartX; applyTransform(); }
      else { dX = e.changedTouches[0].screenX - lStartX; dY = e.changedTouches[0].screenY - lStartY; applyTransform(); }
    }
  }, {passive: false});

  viewEl.addEventListener('touchend', e => {
    track.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    if (isPinch) { if (e.touches.length === 0) isPinch = false; return; }
    if (scale === 1) { 
      let th = window.innerWidth * 0.25;
      if (cTransX < -th && currentIndex < currentGroup.length - 1) { currentIndex++; } 
      else if (cTransX > th && currentIndex > 0) { currentIndex--; }
      cTransX = 0; applyTransform(); updateViewerInfo();
    } else { applyTransform(); }
  }, {passive: true});

  function applyTransform() {
    const baseOffset = -currentIndex * 100;
    if (scale > 1) {
      const activeImg = track.children[currentIndex].querySelector('img');
      let lx = (activeImg.clientWidth * (scale - 1)) / 2, ly = (activeImg.clientHeight * (scale - 1)) / 2;
      dX = Math.min(Math.max(dX, -lx), lx); dY = Math.min(Math.max(dY, -ly), ly);
      track.children[currentIndex].style.transform = `translate(${dX}px, ${dY}px) scale(${scale})`;
      track.style.transform = `translateX(${baseOffset}%)`;
    } else {
      track.children[currentIndex].style.transform = `scale(1)`;
      track.style.transform = `translateX(calc(${baseOffset}% + ${cTransX}px))`;
    }
  }

  function resetZoomParams() { scale = 1; dX = 0; dY = 0; cTransX = 0; Array.from(track.children).forEach(s => s.style.transform = 'scale(1)'); }
</script>
</body>
</html>
